<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>合同合规审查控制台</title>
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        background: #f6f7fb;
        color: #1f2937;
      }
      .container {
        max-width: 1100px;
        margin: 32px auto;
        padding: 0 20px 48px;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .header h1 {
        font-size: 24px;
        margin: 0;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        padding: 20px;
      }
      .card h2 {
        font-size: 18px;
        margin: 0 0 12px;
      }
      .button {
        background: #2563eb;
        border: none;
        color: #fff;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
      }
      .button.secondary {
        background: #e2e8f0;
        color: #1f2937;
      }
      .actions {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }
      input[type="file"] {
        display: block;
        margin-top: 8px;
      }
      .status {
        margin-top: 12px;
        font-size: 13px;
        color: #475569;
        white-space: pre-wrap;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 13px;
      }
      th,
      td {
        padding: 8px 6px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
      }
      td.actions-cell {
        white-space: nowrap;
      }
      .link-button {
        border: none;
        background: none;
        color: #2563eb;
        cursor: pointer;
        padding: 0;
        font-size: 13px;
      }
      .preview {
        background: #0f172a;
        color: #e2e8f0;
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
        max-height: 240px;
        overflow: auto;
        white-space: pre-wrap;
        font-size: 12px;
      }
      .result {
        margin-top: 24px;
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      }
      .result h2 {
        font-size: 18px;
        margin: 0 0 12px;
      }
      .score {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        background: #eef2ff;
        color: #1e3a8a;
        font-weight: 600;
        font-size: 13px;
      }
      .summary {
        margin-top: 12px;
        font-size: 14px;
      }
      .section-block {
        margin-top: 16px;
      }
      .section-title {
        font-weight: 600;
        margin-bottom: 8px;
      }
      .chunk-list {
        display: grid;
        gap: 12px;
      }
      .chunk-card {
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #e2e8f0;
      }
      .chunk-card h3 {
        margin: 0 0 6px;
        font-size: 14px;
      }
      .chunk-risk {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e2e8f0;
      }
      .chunk-risk h4 {
        margin: 0 0 6px;
        font-size: 14px;
      }
      .chunk-details summary {
        cursor: pointer;
        font-weight: 600;
        margin-top: 8px;
      }
      .chunk-content {
        margin-top: 8px;
        background: #0b1120;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 10px;
        white-space: pre-wrap;
        font-size: 12px;
      }
      .issues {
        margin-top: 16px;
        display: grid;
        gap: 12px;
      }
      .issue-card {
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #e2e8f0;
      }
      .issue-card h3 {
        margin: 0 0 6px;
        font-size: 14px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        margin-left: 6px;
        background: #fee2e2;
        color: #991b1b;
      }
      .badge.low {
        background: #dcfce7;
        color: #166534;
      }
      .badge.medium {
        background: #fef9c3;
        color: #854d0e;
      }
      .citation-panel {
        margin-top: 16px;
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #e2e8f0;
      }
      .citation-title {
        font-weight: 600;
        margin-bottom: 8px;
      }
      .citation-content {
        max-height: 260px;
        overflow: auto;
        background: #0b1120;
        color: #e2e8f0;
        padding: 12px;
        border-radius: 8px;
        white-space: pre-wrap;
        font-size: 12px;
      }
      .highlight {
        background: #fde68a;
        color: #7c2d12;
        padding: 0 2px;
        border-radius: 4px;
      }
      .json-view {
        margin-top: 16px;
        background: #0b1120;
        color: #e2e8f0;
        border-radius: 10px;
        padding: 12px;
        max-height: 320px;
        overflow: auto;
        white-space: pre-wrap;
        font-size: 12px;
      }
      .feedback-panel {
        margin-top: 16px;
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        border: 1px solid #e2e8f0;
      }
      .feedback-input {
        width: 100%;
        min-height: 120px;
        margin-top: 8px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-size: 13px;
        resize: vertical;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>合同合规审查控制台</h1>
      </div>
      <div class="grid">
        <div class="card">
          <h2>上传合同</h2>
          <div>支持格式：PDF、DOCX</div>
          <input id="contractFile" type="file" accept=".pdf,.docx" />
          <div class="actions">
            <button class="button" onclick="uploadContract()">上传合同</button>
          </div>
          <div id="contractStatus" class="status"></div>
        </div>
        <div class="card">
          <h2>执行审计</h2>
          <div>选择已上传合同进行合规审查</div>
          <select id="contractSelect" style="margin-top: 8px; width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0">
            <option value="">请选择合同文件</option>
          </select>
          <div class="actions">
            <button class="button" onclick="runAudit()">执行审计</button>
            <button class="button secondary" onclick="loadContracts()">刷新合同列表</button>
          </div>
          <div id="auditStatus" class="status"></div>
        </div>
        <div class="card">
          <h2>法律文件管理</h2>
          <div>支持格式：TXT、MD、PDF、DOCX</div>
          <input id="legalFile" type="file" accept=".txt,.md,.pdf,.docx" />
          <div class="actions">
            <button class="button" onclick="uploadLegal()">上传法律文件</button>
            <button class="button secondary" onclick="loadLegalFiles()">刷新列表</button>
          </div>
          <div id="legalStatus" class="status"></div>
          <table>
            <thead>
              <tr>
                <th>文件名</th>
                <th>大小</th>
                <th>修改时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="legalTable"></tbody>
          </table>
          <div id="legalReformatPanel" style="display: none; margin-top: 12px">
            <div style="font-weight: 600">重排结果</div>
            <textarea id="legalReformatEditor" class="preview" style="margin-top: 8px; height: 420px; max-height: 60vh"></textarea>
            <div class="actions">
              <button id="legalReformatConfirmBtn" class="button" onclick="confirmReformat()" disabled>确认保存</button>
            </div>
            <div id="legalReformatStatus" class="status"></div>
          </div>
          <div id="legalPreview" class="preview" style="display: none"></div>
        </div>
      </div>
      <div class="result" id="auditResult" style="display: none">
        <h2>审计结果</h2>
        <div id="resultScore" class="score"></div>
        <div id="chunkResultPanel" class="section-block" style="display: none">
          <div class="section-title">分块审阅结果</div>
          <div id="chunkResultList" class="chunk-list"></div>
        </div>
        <div id="finalSummaryPanel" class="section-block">
          <div class="section-title">最终总结</div>
          <div id="resultSummary" class="summary"></div>
        </div>
        <div id="tokenUsagePanel" style="margin-top: 16px">
          <div style="font-weight: 600">Token 用量</div>
          <table>
            <thead>
              <tr>
                <th>指标</th>
                <th>数量</th>
              </tr>
            </thead>
            <tbody id="tokenUsageTable"></tbody>
          </table>
        </div>
        <div id="resultIssues" class="issues"></div>
        <div id="citationPanel" class="citation-panel" style="display: none">
          <div id="citationTitle" class="citation-title"></div>
          <div id="citationContent" class="citation-content"></div>
        </div>
        <div id="resultJson" class="json-view"></div>
        <div id="feedbackPanel" class="feedback-panel" style="display: none">
          <div style="font-weight: 600">反馈</div>
          <textarea id="feedbackInput" class="feedback-input" maxlength="2000" placeholder="请输入你的反馈与建议"></textarea>
          <div id="feedbackCounter" class="status"></div>
          <div class="actions">
            <button id="feedbackSubmit" class="button" onclick="submitFeedback()">提交反馈</button>
          </div>
          <div id="feedbackStatus" class="status"></div>
        </div>
      </div>
    </div>
    <script>
      let reformatCache = null;
      let latestAuditResult = null;
      let feedbackSubmitted = false;

      async function uploadContract() {
        const fileInput = document.getElementById("contractFile");
        const status = document.getElementById("contractStatus");
        if (!fileInput.files.length) {
          status.textContent = "请选择合同文件";
          return;
        }
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        status.textContent = "上传中...";
        try {
          const response = await fetch("/api/contract/upload", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "上传失败";
            return;
          }
          status.textContent = `已上传：${data.name} (${data.size} bytes)`;
          fileInput.value = "";
          await loadContracts();
        } catch (error) {
          status.textContent = "上传失败";
        }
      }

      async function uploadLegal() {
        const fileInput = document.getElementById("legalFile");
        const status = document.getElementById("legalStatus");
        if (!fileInput.files.length) {
          status.textContent = "请选择法律文件";
          return;
        }
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        status.textContent = "上传中...";
        try {
          const response = await fetch("/api/legal/upload", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "上传失败";
            return;
          }
          status.textContent = `已上传：${data.name}`;
          fileInput.value = "";
          await loadLegalFiles();
        } catch (error) {
          status.textContent = "上传失败";
        }
      }

      async function reformatLegal(encodedPath) {
        const status = document.getElementById("legalReformatStatus");
        const panel = document.getElementById("legalReformatPanel");
        const editor = document.getElementById("legalReformatEditor");
        const confirmButton = document.getElementById("legalReformatConfirmBtn");
        const preview = document.getElementById("legalPreview");
        const path = decodeURIComponent(encodedPath || "");
        if (!path) {
          status.textContent = "无法获取文件路径";
          return;
        }
        status.textContent = "重排中...";
        panel.style.display = "block";
        preview.style.display = "none";
        confirmButton.disabled = true;
        editor.value = "";
        reformatCache = { path };
        try {
          const response = await fetch("/api/legal/reformat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path }),
          });
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "重排失败";
            return;
          }
          reformatCache = {
            path,
            content: data.content || "",
            name: data.suggested_name || "reformatted.txt",
          };
          editor.value = reformatCache.content || "";
          confirmButton.disabled = !editor.value.trim();
          status.textContent = "重排完成，可编辑后确认保存";
        } catch (error) {
          status.textContent = "重排失败";
        }
      }

      async function confirmReformat() {
        const status = document.getElementById("legalReformatStatus");
        const panel = document.getElementById("legalReformatPanel");
        const editor = document.getElementById("legalReformatEditor");
        const confirmButton = document.getElementById("legalReformatConfirmBtn");
        if (!reformatCache || !reformatCache.path) {
          status.textContent = "请先重排";
          return;
        }
        const content = editor.value || "";
        if (!content.trim()) {
          status.textContent = "内容不能为空";
          return;
        }
        status.textContent = "保存中...";
        confirmButton.disabled = true;
        try {
          const response = await fetch("/api/legal/reformat/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              path: reformatCache.path,
              content,
            }),
          });
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "保存失败";
            confirmButton.disabled = false;
            return;
          }
          status.textContent = `已保存：${data.saved}`;
          panel.style.display = "none";
          reformatCache = null;
          await loadLegalFiles();
        } catch (error) {
          status.textContent = "保存失败";
          confirmButton.disabled = false;
        }
      }

      async function loadLegalFiles() {
        const table = document.getElementById("legalTable");
        const preview = document.getElementById("legalPreview");
        const status = document.getElementById("legalStatus");
        const reformatPanel = document.getElementById("legalReformatPanel");
        preview.style.display = "none";
        reformatPanel.style.display = "none";
        status.textContent = "加载中...";
        try {
          const response = await fetch("/api/legal");
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "加载失败";
            return;
          }
          table.innerHTML = "";
          for (const file of data.files) {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${file.name}</td>
              <td>${file.size}</td>
              <td>${file.modified}</td>
              <td class="actions-cell">
                <button class="link-button" onclick="viewLegal('${encodeURIComponent(file.path)}')">查看</button>
                <button class="link-button" onclick="reformatLegal('${encodeURIComponent(file.path)}')">重排</button>
                <button class="link-button" onclick="deleteLegal('${encodeURIComponent(file.path)}')">删除</button>
              </td>
            `;
            table.appendChild(row);
          }
          status.textContent = `共 ${data.files.length} 个文件`;
        } catch (error) {
          status.textContent = "加载失败";
        }
      }

      async function loadContracts() {
        const select = document.getElementById("contractSelect");
        const status = document.getElementById("auditStatus");
        status.textContent = "加载中...";
        try {
          const response = await fetch("/api/contract/list");
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "加载失败";
            return;
          }
          select.innerHTML = `<option value="">请选择合同文件</option>`;
          for (const file of data.files) {
            const option = document.createElement("option");
            option.value = file.path;
            option.textContent = `${file.name} (${file.modified})`;
            select.appendChild(option);
          }
          status.textContent = `共 ${data.files.length} 个合同`;
        } catch (error) {
          status.textContent = "加载失败";
        }
      }

      async function runAudit() {
        const select = document.getElementById("contractSelect");
        const status = document.getElementById("auditStatus");
        const resultBox = document.getElementById("auditResult");
        if (!select.value) {
          status.textContent = "请选择合同文件";
          return;
        }
        status.textContent = "审计中...";
        resultBox.style.display = "none";
        try {
          const response = await fetch("/api/audit/run", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ contract: select.value }),
          });
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "审计失败";
            return;
          }
          status.textContent = "审计完成";
          const result = data.result ?? data;
          const tokenUsage = data.token_usage ?? null;
          if (!result) {
            status.textContent = "审计失败：空结果";
            return;
          }
          try {
            renderAuditResult(result, tokenUsage);
          } catch (error) {
            status.textContent = "审计结果渲染失败";
          }
        } catch (error) {
          status.textContent = "审计失败";
        }
      }

      function normalizeAuditResult(raw) {
        let result = raw;
        if (typeof result === "string") {
          try {
            result = JSON.parse(result);
          } catch (error) {
            return { summary: "", risks: [], raw_text: raw };
          }
        }
        if (result && result.result) {
          result = result.result;
        }
        if (!result || typeof result !== "object") {
          return { summary: "", risks: [] };
        }
        const risks = Array.isArray(result.risks) ? result.risks : [];
        if (risks.length === 0 && Array.isArray(result.issues)) {
          const mapped = result.issues.map((issue, index) => {
            const citations = Array.isArray(issue.legal_citations) ? issue.legal_citations : [];
            return {
              risk_id: `ISSUE-${index + 1}`,
              clause_id: issue.clause_id || "",
              title: issue.title || issue.risk_reason || "风险",
              level: issue.risk_level || issue.level || "",
              score: issue.risk_score ?? issue.score ?? null,
              confidence: issue.confidence || "",
              contract_evidence: issue.clause_excerpt || "",
              law_evidence: citations.map((item) => ({
                source_path: item.source_path || "",
                law_ref_id: item.article_no || item.law_ref_id || "",
                quote: item.quote || "",
              })),
              risk_reason: issue.risk_reason || "",
              suggested_text: issue.suggestion || issue.suggested_text || "",
              trigger: issue.trigger || "",
              impact_analysis: issue.impact_analysis || "",
            };
          });
          return { ...result, risks: mapped };
        }
        return { ...result, risks };
      }

      function renderAuditResult(raw, tokenUsage) {
        const result = normalizeAuditResult(raw);
        const resultBox = document.getElementById("auditResult");
        const score = document.getElementById("resultScore");
        const summary = document.getElementById("resultSummary");
        const issues = document.getElementById("resultIssues");
        const jsonView = document.getElementById("resultJson");
        const tokenUsageTable = document.getElementById("tokenUsageTable");
        const feedbackPanel = document.getElementById("feedbackPanel");
        const feedbackStatus = document.getElementById("feedbackStatus");
        const feedbackInput = document.getElementById("feedbackInput");
        const feedbackCounter = document.getElementById("feedbackCounter");
        const citationPanel = document.getElementById("citationPanel");
        const citationTitle = document.getElementById("citationTitle");
        const citationContent = document.getElementById("citationContent");
        const chunkPanel = document.getElementById("chunkResultPanel");
        const chunkList = document.getElementById("chunkResultList");
        const counts = (result.overall || {}).risk_count || {};
        let highCount = counts.high ?? 0;
        let mediumCount = counts.medium ?? 0;
        let lowCount = counts.low ?? 0;
        if (!counts.high && !counts.medium && !counts.low) {
          for (const risk of result.risks || []) {
            if (risk.level === "高") {
              highCount += 1;
            } else if (risk.level === "中") {
              mediumCount += 1;
            } else if (risk.level === "低") {
              lowCount += 1;
            }
          }
        }
        score.textContent = `风险数量：高${highCount} 中${mediumCount} 低${lowCount}`;
        summary.textContent = result.summary || "";
        chunkList.innerHTML = "";
        const chunkResults = Array.isArray(result.chunk_results) ? result.chunk_results : [];
        if (chunkResults.length) {
          chunkPanel.style.display = "block";
          for (let i = 0; i < chunkResults.length; i += 1) {
            const chunk = chunkResults[i] || {};
            const card = document.createElement("div");
            card.className = "chunk-card";
            const title = document.createElement("h3");
            const index = chunk.chunk_index ?? i + 1;
            const total = chunk.chunk_total ?? chunkResults.length;
            title.textContent = `第 ${index}/${total} 块`;
            const chunkSummary = document.createElement("div");
            chunkSummary.textContent = `结论：${chunk.summary || ""}`;
            card.appendChild(title);
            card.appendChild(chunkSummary);
            const chunkText = chunk.chunk_text || "";
            if (chunkText) {
              const details = document.createElement("details");
              details.className = "chunk-details";
              const summary = document.createElement("summary");
              summary.textContent = "合同分块内容";
              const content = document.createElement("div");
              content.className = "chunk-content";
              content.textContent = chunkText;
              details.appendChild(summary);
              details.appendChild(content);
              card.appendChild(details);
            }
            const risks = Array.isArray(chunk.risks) ? chunk.risks : [];
            if (!risks.length) {
              const empty = document.createElement("div");
              empty.textContent = "无风险项";
              card.appendChild(empty);
            } else {
              for (const risk of risks) {
                const riskBlock = document.createElement("div");
                riskBlock.className = "chunk-risk";
                const riskTitle = document.createElement("h4");
                const level = risk.level || "";
                riskTitle.textContent = `${risk.title || risk.clause_id || "风险"}${level}`;
                const reason = document.createElement("div");
                reason.textContent = `风险说明：${risk.risk_reason || ""}`;
                const meta = document.createElement("div");
                meta.textContent = `分值：${risk.score ?? "-"} 置信度：${risk.confidence || ""}`;
                const evidence = document.createElement("div");
                evidence.textContent = `合同证据：${risk.contract_evidence || ""}`;
                const trigger = document.createElement("div");
                trigger.textContent = `触发条件：${risk.trigger || ""}`;
                const impact = document.createElement("div");
                impact.textContent = `影响分析：${risk.impact_analysis || ""}`;
                const suggestion = document.createElement("div");
                suggestion.textContent = `替换建议：${risk.suggested_text || ""}`;
                const citationsWrap = document.createElement("div");
                citationsWrap.style.marginTop = "6px";
                citationsWrap.style.display = "grid";
                citationsWrap.style.gap = "6px";
                const lawEvidence = Array.isArray(risk.law_evidence) ? risk.law_evidence : [];
                for (const item of lawEvidence) {
                  const row = document.createElement("div");
                  const link = document.createElement("a");
                  link.className = "link-button";
                  link.textContent = `[${item.source_path}] ${item.law_ref_id || ""}`.trim();
                  link.href = "javascript:void(0)";
                  link.addEventListener("click", () =>
                    openCitation(item.source_path || "", item.quote || "")
                  );
                  const quote = document.createElement("div");
                  quote.style.whiteSpace = "pre-wrap";
                  quote.textContent = item.quote || "";
                  row.appendChild(link);
                  row.appendChild(quote);
                  citationsWrap.appendChild(row);
                }
                riskBlock.appendChild(riskTitle);
                riskBlock.appendChild(reason);
                riskBlock.appendChild(meta);
                riskBlock.appendChild(evidence);
                riskBlock.appendChild(trigger);
                riskBlock.appendChild(impact);
                riskBlock.appendChild(suggestion);
                riskBlock.appendChild(citationsWrap);
                card.appendChild(riskBlock);
              }
            }
            chunkList.appendChild(card);
          }
        } else {
          chunkPanel.style.display = "none";
        }
        tokenUsageTable.innerHTML = "";
        const usage = tokenUsage || {};
        const cached = usage.prompt_cached ?? null;
        const uncached = usage.prompt_uncached ?? null;
        const completion = usage.completion ?? null;
        const rows = [
          { label: "输入 token（缓存命中）", value: cached },
          { label: "输入 token（未缓存）", value: uncached },
          { label: "输出 token", value: completion },
        ];
        for (const row of rows) {
          const item = document.createElement("tr");
          const value = row.value === null || row.value === undefined ? "-" : row.value;
          item.innerHTML = `<td>${row.label}</td><td>${value}</td>`;
          tokenUsageTable.appendChild(item);
        }
        issues.innerHTML = "";
        citationPanel.style.display = "none";
        citationTitle.textContent = "";
        citationContent.textContent = "";
        for (const risk of result.risks || []) {
          const card = document.createElement("div");
          card.className = "issue-card";
          const title = document.createElement("h3");
          const level = risk.level || "";
          const badge = document.createElement("span");
          badge.className =
            level === "低" ? "badge low" : level === "中" ? "badge medium" : "badge";
          badge.textContent = level;
          title.textContent = risk.title || risk.clause_id || "条款";
          title.appendChild(badge);
          const reason = document.createElement("div");
          reason.textContent = `风险说明：${risk.risk_reason || ""}`;
          const meta = document.createElement("div");
          meta.textContent = `分值：${risk.score ?? "-"} 置信度：${risk.confidence || ""}`;
          const evidence = document.createElement("div");
          evidence.textContent = `合同证据：${risk.contract_evidence || ""}`;
          const suggestion = document.createElement("div");
          suggestion.textContent = `替换建议：${risk.suggested_text || ""}`;
          const trigger = document.createElement("div");
          trigger.textContent = `触发条件：${risk.trigger || ""}`;
          const impact = document.createElement("div");
          impact.textContent = `影响分析：${risk.impact_analysis || ""}`;
          const citationsWrap = document.createElement("div");
          citationsWrap.style.marginTop = "6px";
          citationsWrap.style.display = "grid";
          citationsWrap.style.gap = "6px";
          const lawEvidence = Array.isArray(risk.law_evidence) ? risk.law_evidence : [];
          for (const item of lawEvidence) {
            const row = document.createElement("div");
            const link = document.createElement("a");
            link.className = "link-button";
            link.textContent = `[${item.source_path}] ${item.law_ref_id || ""}`.trim();
            link.href = "javascript:void(0)";
            link.addEventListener("click", () =>
              openCitation(item.source_path || "", item.quote || "")
            );
            const quote = document.createElement("div");
            quote.style.whiteSpace = "pre-wrap";
            quote.textContent = item.quote || "";
            row.appendChild(link);
            row.appendChild(quote);
            citationsWrap.appendChild(row);
          }
          card.appendChild(title);
          card.appendChild(reason);
          card.appendChild(meta);
          card.appendChild(evidence);
          card.appendChild(trigger);
          card.appendChild(impact);
          card.appendChild(suggestion);
          card.appendChild(citationsWrap);
          issues.appendChild(card);
        }
        jsonView.textContent = JSON.stringify(result, null, 2);
        const feedbackResult = { ...result };
        if (feedbackResult.chunk_results) {
          delete feedbackResult.chunk_results;
        }
        latestAuditResult = feedbackResult;
        feedbackSubmitted = false;
        feedbackPanel.style.display = "block";
        feedbackStatus.textContent = "";
        feedbackInput.value = "";
        feedbackInput.disabled = false;
        feedbackCounter.textContent = "至少输入 10 字，最多 2000 字";
        updateFeedbackState();
        resultBox.style.display = "block";
        resultBox.scrollIntoView({ behavior: "smooth" });
      }

      function updateFeedbackState() {
        const input = document.getElementById("feedbackInput");
        const counter = document.getElementById("feedbackCounter");
        const button = document.getElementById("feedbackSubmit");
        const value = (input.value || "").trim();
        const length = value.length;
        if (feedbackSubmitted) {
          counter.textContent = "已提交反馈，需要重新审计后才能再次提交";
          button.disabled = true;
          input.disabled = true;
          return;
        }
        counter.textContent = `已输入 ${length} 字，至少 10 字，最多 2000 字`;
        button.disabled = length < 10 || length > 2000;
        input.disabled = false;
      }

      async function submitFeedback() {
        const input = document.getElementById("feedbackInput");
        const status = document.getElementById("feedbackStatus");
        const button = document.getElementById("feedbackSubmit");
        const feedback = (input.value || "").trim();
        if (feedbackSubmitted) {
          status.textContent = "已提交反馈，需要重新审计后才能再次提交";
          return;
        }
        if (!latestAuditResult) {
          status.textContent = "请先完成审计";
          return;
        }
        if (!feedback) {
          status.textContent = "请输入反馈";
          return;
        }
        if (feedback.length < 10) {
          status.textContent = "反馈内容太短";
          return;
        }
        if (feedback.length > 2000) {
          status.textContent = "反馈内容过长";
          return;
        }
        status.textContent = "提交中...";
        button.disabled = true;
        try {
          const response = await fetch("/api/audit/feedback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              feedback,
              audit_result: latestAuditResult,
            }),
          });
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "提交失败";
            return;
          }
          feedbackSubmitted = true;
          status.textContent = "已提交";
          input.value = "";
          updateFeedbackState();
        } catch (error) {
          status.textContent = "提交失败";
        } finally {
          if (!feedbackSubmitted) {
            button.disabled = false;
          }
        }
      }

      document.addEventListener("input", (event) => {
        if (event.target && event.target.id === "feedbackInput") {
          updateFeedbackState();
        }
      });

      function escapeHtml(text) {
        return text
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }

      function isMeaningfulChar(ch) {
        return /[A-Za-z0-9\u4e00-\u9fff]/.test(ch);
      }

      function normalizeText(text) {
        return text
          .split("")
          .filter((ch) => isMeaningfulChar(ch))
          .join("")
          .toLowerCase();
      }

      function buildNormalizedMap(raw) {
        const map = [];
        let normalized = "";
        let normalizedIndex = 0;
        for (let i = 0; i < raw.length; i += 1) {
          const ch = raw[i];
          if (!isMeaningfulChar(ch)) {
            continue;
          }
          map[normalizedIndex] = i;
          normalizedIndex += 1;
          normalized += ch.toLowerCase();
        }
        return { normalized, map };
      }

      function findNormalizedRangeFromMap(mapData, quote) {
        const normalizedRaw = mapData.normalized;
        const normalizedQuote = normalizeText(quote);
        if (!normalizedQuote) {
          return null;
        }
        const index = normalizedRaw.indexOf(normalizedQuote);
        if (index < 0) {
          return null;
        }
        const start = mapData.map[index];
        const end = mapData.map[index + normalizedQuote.length - 1];
        if (start === undefined || end === undefined) {
          return null;
        }
        return { start, end: end + 1 };
      }

      function findSnippetRangeFromMap(mapData, quote) {
        const normalizedRaw = mapData.normalized;
        const normalizedQuote = normalizeText(quote);
        if (!normalizedQuote) {
          return null;
        }
        const size = Math.min(24, normalizedQuote.length);
        if (size < 6) {
          return null;
        }
        const head = normalizedQuote.slice(0, size);
        let index = normalizedRaw.indexOf(head);
        if (index < 0) {
          const tail = normalizedQuote.slice(-size);
          index = normalizedRaw.indexOf(tail);
          if (index < 0) {
            return null;
          }
        }
        const start = mapData.map[index];
        const end = mapData.map[index + size - 1];
        if (start === undefined || end === undefined) {
          return null;
        }
        return { start, end: end + 1 };
      }

      async function openCitation(path, quote) {
        const panel = document.getElementById("citationPanel");
        const title = document.getElementById("citationTitle");
        const content = document.getElementById("citationContent");
        if (!path) {
          panel.style.display = "none";
          return;
        }
        title.textContent = `条文来源：${path}`;
        content.textContent = "加载中...";
        panel.style.display = "block";
        try {
          const response = await fetch(`/api/legal/content?path=${encodeURIComponent(path)}`);
          const data = await response.json();
          if (!response.ok) {
            content.textContent = data.error || "读取失败";
            return;
          }
          const raw = data.content || "";
          const safe = escapeHtml(raw);
          const mapData = buildNormalizedMap(raw);
          if (quote) {
            const index = raw.indexOf(quote);
            if (index >= 0) {
              const before = escapeHtml(raw.slice(0, index));
              const hit = escapeHtml(raw.slice(index, index + quote.length));
              const after = escapeHtml(raw.slice(index + quote.length));
              content.innerHTML = `${before}<span class="highlight">${hit}</span>${after}`;
              const marker = content.querySelector(".highlight");
              if (marker) {
                marker.scrollIntoView({ behavior: "smooth", block: "center" });
              }
              return;
            }
            const range = findNormalizedRangeFromMap(mapData, quote);
            if (range) {
              const before = escapeHtml(raw.slice(0, range.start));
              const hit = escapeHtml(raw.slice(range.start, range.end));
              const after = escapeHtml(raw.slice(range.end));
              content.innerHTML = `${before}<span class="highlight">${hit}</span>${after}`;
              const marker = content.querySelector(".highlight");
              if (marker) {
                marker.scrollIntoView({ behavior: "smooth", block: "center" });
              }
              return;
            }
            const snippetRange = findSnippetRangeFromMap(mapData, quote);
            if (snippetRange) {
              const before = escapeHtml(raw.slice(0, snippetRange.start));
              const hit = escapeHtml(raw.slice(snippetRange.start, snippetRange.end));
              const after = escapeHtml(raw.slice(snippetRange.end));
              content.innerHTML = `${before}<span class="highlight">${hit}</span>${after}`;
              const marker = content.querySelector(".highlight");
              if (marker) {
                marker.scrollIntoView({ behavior: "smooth", block: "center" });
              }
              return;
            }
          }
          content.innerHTML = safe;
        } catch (error) {
          content.textContent = "读取失败";
        }
      }

      async function viewLegal(path) {
        const preview = document.getElementById("legalPreview");
        const panel = document.getElementById("legalReformatPanel");
        preview.style.display = "block";
        panel.style.display = "none";
        preview.textContent = "加载中...";
        try {
          const response = await fetch(`/api/legal/content?path=${path}`);
          const data = await response.json();
          if (!response.ok) {
            preview.textContent = data.error || "读取失败";
            return;
          }
          preview.textContent = data.content || "无内容";
        } catch (error) {
          preview.textContent = "读取失败";
        }
      }

      async function deleteLegal(path) {
        const status = document.getElementById("legalStatus");
        status.textContent = "删除中...";
        try {
          const response = await fetch(`/api/legal?path=${path}`, {
            method: "DELETE",
          });
          const data = await response.json();
          if (!response.ok) {
            status.textContent = data.error || "删除失败";
            return;
          }
          status.textContent = `已删除：${data.deleted}`;
          await loadLegalFiles();
        } catch (error) {
          status.textContent = "删除失败";
        }
      }

      loadLegalFiles();
      loadContracts();
    </script>
  </body>
</html>
